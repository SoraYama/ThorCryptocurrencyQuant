# ThorCryptoCurrency Strategy Library 项目架构图

## 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    ThorCryptoCurrency Strategy Library      │
├─────────────────────────────────────────────────────────────┤
│  策略层 (Strategy Layer)                                    │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ 平衡策略    │ 网格策略    │ 吃针策略    │ 指标策略    │  │
│  │             │             │             │             │  │
│  │ 对敲策略    │ 套利策略    │ 自定义策略  │ 扩展策略    │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  交易引擎层 (Trading Engine Layer)                          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Quant.py (交易逻辑核心)                                │ │
│  │  - 订单管理                                             │ │
│  │  - 风险控制                                             │ │
│  │  - 策略执行                                             │ │
│  │  - 异常处理                                             │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  数据层 (Data Layer)                                        │
│  ┌─────────────────┬─────────────────┬─────────────────┐    │
│  │ WebSocket 连接  │ MongoDB 数据库  │ CCXT 交易所API  │    │
│  │ - 实时行情      │ - 订单状态      │ - 统一接口      │    │
│  │ - 订单推送      │ - 历史数据      │ - 多交易所支持  │    │
│  │ - 自动重连      │ - 参数存储      │ - 数据标准化    │    │
│  └─────────────────┴─────────────────┴─────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│  交易所层 (Exchange Layer)                                  │
│  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐    │
│  │BitMEX│Bybit│Binance│OKEX│Huobi│Bitfinex│Coinbase│...│    │
│  │期货  │永续 │现货   │现货 │现货 │现货   │现货   │    │    │
│  │永续  │合约 │永续   │永续 │期货 │       │       │    │    │
│  │合约  │     │合约   │合约 │永续 │       │       │    │    │
│  └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件详细架构

### 1. 网格策略组件架构

```
┌─────────────────────────────────────────────────────────────┐
│                    网格策略 (Grid Strategy)                  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  bitmex_main-xbt.py (主程序入口)                        │ │
│  │  - 参数配置                                             │ │
│  │  - 策略初始化                                           │ │
│  │  - 程序启动                                             │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Quant.py (交易逻辑核心)                                │ │
│  │  ┌─────────────────┬─────────────────┬─────────────────┐ │ │
│  │  │ 初始化模块      │ 交易执行模块    │ 订单管理模块    │ │ │
│  │  │ - 参数设置      │ - 网格布局      │ - 订单创建      │ │ │
│  │  │ - 交易所连接    │ - 批量下单      │ - 状态跟踪      │ │ │
│  │  │ - 数据库连接    │ - 利润计算      │ - 自动重挂      │ │ │
│  │  └─────────────────┴─────────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  bitmex_websocket/_websocket.py (实时数据)              │ │
│  │  ┌─────────────────┬─────────────────┬─────────────────┐ │ │
│  │  │ 连接管理        │ 数据接收        │ 状态更新        │ │ │
│  │  │ - 自动重连      │ - 行情数据      │ - 订单状态      │ │ │
│  │  │ - 心跳保活      │ - 订单推送      │ - 数据库同步    │ │ │
│  │  │ - 异常处理      │ - 认证管理      │ - 实时监控      │ │ │
│  │  └─────────────────┴─────────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2. 数据流架构

```
┌─────────────────────────────────────────────────────────────┐
│                        数据流向图                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  交易所 API ──────┐                                         │
│                   │                                         │
│                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              CCXT 统一接口层                            │ │
│  │  - 数据标准化                                           │ │
│  │  - 接口统一化                                           │ │
│  │  - 错误处理                                             │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                                         │
│                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              交易引擎层                                 │ │
│  │  ┌─────────────┬─────────────┬─────────────┐            │ │
│  │  │ 策略逻辑    │ 订单管理    │ 风险控制    │            │ │
│  │  └─────────────┴─────────────┴─────────────┘            │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                                         │
│                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              数据存储层                                 │ │
│  │  ┌─────────────┬─────────────┬─────────────┐            │ │
│  │  │ MongoDB     │ 日志文件    │ 配置文件    │            │ │
│  │  │ - 订单状态  │ - 运行日志  │ - 策略参数  │            │ │
│  │  │ - 历史数据  │ - 错误日志  │ - 系统配置  │            │ │
│  │  └─────────────┴─────────────┴─────────────┘            │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  WebSocket ──────┐                                          │
│                  │                                          │
│                  ▼                                          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              实时数据流                                 │ │
│  │  - 行情数据推送                                         │ │
│  │  - 订单状态更新                                         │ │
│  │  - 异常事件通知                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3. 网格策略执行流程

```
┌─────────────────────────────────────────────────────────────┐
│                    网格策略执行流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 初始化阶段                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  - 加载配置参数                                         │ │
│  │  - 连接交易所                                           │ │
│  │  - 连接数据库                                           │ │
│  │  - 启动 WebSocket                                       │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                                         │
│                   ▼                                         │
│  2. 网格布局阶段                                            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  - 获取当前价格                                         │ │
│  │  - 计算网格价格点                                       │ │
│  │  - 批量创建买卖订单                                     │ │
│  │  - 存储订单到数据库                                     │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                                         │
│                   ▼                                         │
│  3. 监控执行阶段                                            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  - 实时监控订单状态                                     │ │
│  │  - 处理订单成交                                         │ │
│  │  - 自动创建反向订单                                     │ │
│  │  - 处理订单取消                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                                         │
│                   ▼                                         │
│  4. 异常处理阶段                                            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  - 网络异常重连                                         │ │
│  │  - 订单异常处理                                         │ │
│  │  - 系统异常恢复                                         │ │
│  │  - 日志记录                                             │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 技术栈架构

### 1. 编程语言和框架
```
┌─────────────────────────────────────────────────────────────┐
│                    技术栈架构                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Python 3.8+ (主要开发语言)                            │ │
│  │  - 面向对象编程                                         │ │
│  │  - 多线程处理                                           │ │
│  │  - 异常处理机制                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  CCXT (加密货币交易所统一API)                          │ │
│  │  - 100+ 交易所支持                                      │ │
│  │  - 统一的数据格式                                       │ │
│  │  - 标准化的接口                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  MongoDB (数据库)                                       │ │
│  │  - 文档型数据库                                         │ │
│  │  - 高性能读写                                           │ │
│  │  - 灵活的数据结构                                       │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  WebSocket (实时通信)                                   │ │
│  │  - 低延迟通信                                           │ │
│  │  - 双向数据传输                                         │ │
│  │  - 自动重连机制                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2. 依赖关系图

```
┌─────────────────────────────────────────────────────────────┐
│                    依赖关系图                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  bitmex_main-xbt.py                                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  ┌─────────────────┐    ┌─────────────────┐            │ │
│  │  │  Quant.py       │    │  _websocket.py  │            │ │
│  │  │  (交易逻辑)     │    │  (实时数据)     │            │ │
│  │  └─────────────────┘    └─────────────────┘            │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                     │                   │
│                   ▼                     ▼                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  ┌─────────────────┐    ┌─────────────────┐            │ │
│  │  │  ccxt           │    │  pymongo        │            │ │
│  │  │  (交易所API)    │    │  (数据库)       │            │ │
│  │  └─────────────────┘    └─────────────────┘            │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                     │                   │
│                   ▼                     ▼                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  ┌─────────────────┐    ┌─────────────────┐            │ │
│  │  │  websocket-     │    │  requests       │            │ │
│  │  │  client         │    │  (HTTP请求)     │            │ │
│  │  │  (WebSocket)    │    │                 │            │ │
│  │  └─────────────────┘    └─────────────────┘            │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 部署架构

### 1. 单机部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                    单机部署架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Linux/macOS/Windows 服务器                            │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │  Python 3.8+ 环境                                  │ │ │
│  │  │  ┌─────────────────┬─────────────────┬─────────────┐ │ │ │
│  │  │  │  策略程序       │  WebSocket      │  数据库     │ │ │ │
│  │  │  │  - 网格策略     │  - 实时连接     │  - MongoDB  │ │ │ │
│  │  │  │  - 订单管理     │  - 数据推送     │  - 状态存储 │ │ │ │
│  │  │  │  - 风险控制     │  - 异常处理     │  - 历史记录 │ │ │ │
│  │  │  └─────────────────┴─────────────────┴─────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  外部连接                                               │ │
│  │  ┌─────────────────┬─────────────────┬─────────────────┐ │ │
│  │  │  交易所API      │  行情数据       │  管理界面       │ │ │
│  │  │  - BitMEX       │  - 实时价格     │  - 监控面板     │ │ │
│  │  │  - Binance      │  - 订单状态     │  - 日志查看     │ │ │
│  │  │  - OKEX         │  - 交易信号     │  - 参数调整     │ │ │
│  │  └─────────────────┴─────────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2. 分布式部署架构（扩展）

```
┌─────────────────────────────────────────────────────────────┐
│                    分布式部署架构                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  负载均衡器                                             │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │  Nginx/HAProxy                                     │ │ │
│  │  │  - 请求分发                                         │ │ │
│  │  │  - 健康检查                                         │ │ │
│  │  │  - 故障转移                                         │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                                         │
│                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  应用服务器集群                                         │ │
│  │  ┌─────────────┬─────────────┬─────────────┐            │ │
│  │  │  服务器1    │  服务器2    │  服务器N    │            │ │
│  │  │  - 策略A    │  - 策略B    │  - 策略N    │            │ │
│  │  │  - 交易所1  │  - 交易所2  │  - 交易所N  │            │ │
│  │  └─────────────┴─────────────┴─────────────┘            │ │
│  └─────────────────────────────────────────────────────────┘ │
│                   │                                         │
│                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  数据存储层                                             │ │
│  │  ┌─────────────┬─────────────┬─────────────┐            │ │
│  │  │  MongoDB    │  Redis      │  文件存储   │            │ │
│  │  │  集群       │  缓存       │  - 日志     │            │ │
│  │  │  - 主从复制 │  - 会话存储 │  - 配置     │            │ │
│  │  │  - 分片     │  - 数据缓存 │  - 备份     │            │ │
│  │  └─────────────┴─────────────┴─────────────┘            │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 安全架构

### 1. 安全防护层

```
┌─────────────────────────────────────────────────────────────┐
│                    安全防护架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  网络安全层                                             │ │
│  │  ┌─────────────────┬─────────────────┬─────────────────┐ │ │
│  │  │  防火墙         │  VPN            │  SSL/TLS        │ │ │
│  │  │  - 端口控制     │  - 加密隧道     │  - 数据加密     │ │ │
│  │  │  - 访问限制     │  - 身份认证     │  - 证书验证     │ │ │
│  │  └─────────────────┴─────────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  应用安全层                                             │ │
│  │  ┌─────────────────┬─────────────────┬─────────────────┐ │ │
│  │  │  API密钥管理    │  权限控制       │  数据验证       │ │ │
│  │  │  - 加密存储     │  - 角色管理     │  - 输入检查     │ │ │
│  │  │  - 定期轮换     │  - 操作审计     │  - 异常检测     │ │ │
│  │  └─────────────────┴─────────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  数据安全层                                             │ │
│  │  ┌─────────────────┬─────────────────┬─────────────────┐ │ │
│  │  │  数据加密       │  备份恢复       │  访问控制       │ │ │
│  │  │  - 传输加密     │  - 定期备份     │  - 身份认证     │ │ │
│  │  │  - 存储加密     │  - 异地存储     │  - 操作日志     │ │ │
│  │  └─────────────────┴─────────────────┴─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

这个架构图展示了 ThorCryptoCurrency Strategy Library 的完整技术架构，包括：

1. **整体架构**：从策略层到交易所层的完整架构
2. **核心组件**：网格策略的详细组件结构
3. **数据流**：数据在系统中的流向和处理
4. **执行流程**：网格策略的完整执行流程
5. **技术栈**：使用的技术和依赖关系
6. **部署架构**：单机和分布式部署方案
7. **安全架构**：多层次的安全防护体系

这个架构设计确保了系统的：
- **可扩展性**：模块化设计，易于添加新策略和交易所
- **可维护性**：清晰的层次结构，便于维护和调试
- **可靠性**：完善的异常处理和恢复机制
- **安全性**：多层次的安全防护体系
- **性能**：高效的数据处理和实时响应能力
